<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binding - Input Form</title>
    <link rel="shortcut icon" type="image/x-icon" href="./images/plain-logo.svg" />
    <style>
        *{
            padding: 0;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #header{
            height: 30vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #imageCard > img{
            width: 150px;
        }
        
        #form{
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #form > form{
            width: 60vw;
        }
        
        #dcCard{
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .input-card{
            height: 40px;
            border-radius: 8px;
            border: 1px solid #D0D5DD;
            padding: 10px, 14px, 10px, 14px;
            width: 100%; 
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .input-card > img{
            height: 20px;
            width: 20px;
            margin-left: 10px;
            margin-right: 10px;
        }

        .input-card > input{
            width: 100%;
            margin-right: 10px;
            height: 20px;
            border: none;
        }
        
        #phoneCard{
            margin-bottom: 30px;
            font-size: 14px;
        }

        #checkBoxCard{
            margin-bottom: 10px;
            font-size: 12px;
        }

        #checkBoxCard a{
            font-size: 12px;
            border: none;
            background: none;
            color: #FF8736;
            cursor: pointer;
        }

        #submitButton{
            display: flex;
            justify-content: center;
            align-items: center;
            height: 96px;
            font-size: 16px;
        }
        
        #submitButton > button{
            font-weight: 600;
            font-size: 16px;
            width: 100%;
            height: 48px;
            border-radius: 24px;
        }
        
        .active-button{
            color: white;
            background-color: #FF8736; 
            border: 1px solid #FF8736;                  
            cursor: pointer;
        }
        
        .active-button:hover{
            background-color: #df7b38;
            color: #e3dbdb
        }
        
        .loading-button{
            color: #e3dbdb;
            background-color: #df7b38;
            border: 1px solid #FF8736;                  
        }

        .nonactive-button{
            color: #98A2B3;
            background-color: #EAECF0;
            border: 1px solid #EAECF0;
            cursor: default;
        }
        
        #loadingIcon{
            display: none;
        }
        
        #loadingIcon > img{
            animation: flipAnimation 5s infinite linear;
        }

        @keyframes flipAnimation {
            100% {transform: rotate(360deg);}
        }

        /* util  */
        .mb-6{
            margin-bottom: 6px;
        }

        .mb-16{
            margin-bottom: 16px;
        }

        /* modal  */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            top: 0;
            left: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(12, 17, 29, 0.9)
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60vw; /* Could be more or less, depending on screen size */
            background-color: white;
            font-size: 14px;
            border-radius: 30px;
            padding: 16px;
            text-align: justify;
        }

        .modal-content > h2{
            font-size: 18px;
            margin-top: 10px;
            margin-bottom: 10px;
            text-align: center;
        }

        .modal-content > p{
            margin-bottom: 10px;
        }

        .close {
            margin-top: 10px;
            width: 100%;
            height: 48px;
            border-radius: 24px;
            padding: 12px 18px 12px 18px;
            background-color: #FF8736;
            border: 1px solid #FF8736;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .close:hover{
            text-decoration: none;
            cursor: pointer;
            color: rgb(227, 219, 219);
            background-color: #df7b38;
        }

        /* iPads (landscape) ----------- */
        @media only screen and (max-width : 1224px) {
            #header{
                height: 200px;
            }
        }

        /* Smartphones (landscape) ----------- */
        @media only screen and (max-width : 768px) {
            #header{
                height: 150px;
            }

            #imageCard > img{
                width: 120px;
            }

            #form{
                padding: 0 48px 24px 48px;
            }
            
            #form > form{
                width: 100%;
            }
        }

        /* Smartphones (portrait) (ie: Galaxy 1) */
        @media only screen and (max-width : 321px) {
            #form{
                padding: 0 24px 24px 24px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
    <!-- header -->
    <div id="header">
        <div id="imageCard">
            <Img src="./images/Logo BNI - Primary.svg"></Img>
        </div>
    </div>

    <!-- form  -->
    <div id="form">
        <form>
            <div id="dcCard">
                <p class="mb-6"><b>Nomor Kartu Debit</b></p>
                <div class="input-card">
                    <img src="./images/dc-icon.svg">
                    <input type="text" id="dcInput" placeholder="Masukkan nomor kartu debit" required>
                </div> 
            </div>
            <div id="phoneCard">
                <p class="mb-6"><b>Nomor Telepon</b></p>
                <div class="input-card">
                    <img src="./images/phone-number-icon.svg">
                    <input type="text" id="phoneInput" placeholder="Masukkan nomor telepon" required>
                </div>
                <p>Masukkan nomor handphone yang terdaftar di BNI</p>
            </div>
            <div id="checkBoxCard">
                <input type="checkbox" id="check1" name="check1" value="check1" required>
                <label for="check1">Dengan ini saya sudah menyetujui <a type="button" id="termsAndConditions"><u>Syarat dan Ketentuan</u></a> layanan BNI.</label><br>
                <input type="checkbox" id="check2" name="check2" value="check2" required>
                <label for="check2">Dengan ini saya menyetujui agar dapat mengakses fitur <b>Pembayaran</b> melalui aplikasi/system/web “PT Tokopedia”.</label><br>
            </div>
            <div id="submitButton">
                <button type="submit" id="submitForm" class="nonactive-button" disabled>
                    <span id="loadingIcon"><img src="./images/loader.svg"></span>
                    <span id="buttonText">Lanjutkan</span>
                </button>
            </div>
        </form>

        <p class="response"></p>
    </div>
    
    <!-- modal  -->
    <div id="termsAndConditionsModal" class="modal">
        <div class="modal-content">
            <h2>Syarat dan ketentuan</h2>
            <p>Lorem ipsum dolor sit amet consectetur. Tortor tincidunt ornare lacus enim odio diam tellus sodales malesuada. Elementum senectus turpis dui id ac lectus. Venenatis a at nulla in. Cursus justo dis nulla morbi quam integer posuere. Nullam turpis vivamus tincidunt etiam nisl nulla amet tincidunt. Posuere cursus dignissim facilisi cursus feugiat nisi. Ut hendrerit sagittis elit sapien at a sodales molestie.</p>
            <p>Lorem ipsum dolor sit amet consectetur. Tortor tincidunt ornare lacus enim odio diam tellus sodales malesuada. Elementum senectus turpis dui id ac lectus. Venenatis a at nulla in. Cursus justo dis nulla morbi quam integer posuere. Nullam turpis vivamus tincidunt etiam nisl nulla amet tincidunt. Posuere cursus dignissim facilisi cursus feugiat nisi. Ut hendrerit sagittis elit sapien at a sodales molestie.</p>
            <button class="close" type="button" id="closeTermsAndConditions">Tutup</button>
        </div>
    </div>
    
    <script>
        $(document).ready(function(){
            // modal handler
            $("#termsAndConditions").on("click", function() {
                console.log("helo")
                $("#termsAndConditionsModal").css("display", "flex")
            })
            
            $("#closeTermsAndConditions").on("click", function() {
                $("#termsAndConditionsModal").css("display", "none")
            })
            
            $(window).on("click", function(event) {
                if (event.target == document.getElementById("termsAndConditionsModal")) {
                    $("#termsAndConditionsModal").css("display", "none")
                }
            }) 
            
            // input formatter
            const mask = (value, limit, separator) => {
                var output = [];
                for (let i = 0; i < value.length; i++) {
                    if ( i !== 0 && i % limit === 0) {
                        output.push(separator);
                    }
                    
                    output.push(value[i]);
                }
                
                return output.join("");
            }
                
            const unmask = (value) => value.replace(/[^\d]/g, '')

            const checkSeparator = (position, interval) => Math.floor(position / (interval + 1))
            
            // cc input formatter
            let ccNumberInput = $("#dcInput")
            let ccNumberPattern = /^\d{0,16}$/g
            let ccNumberSeparator = "-"
            let ccNumberInputOldValue
            let ccNumberInputOldCursor
            
            const ccNumberInputKeyDownHandler = (e) => {
                let el = e.target;
                ccNumberInputOldValue = el.value;
                ccNumberInputOldCursor = el.selectionEnd;
            }
            
            const ccNumberInputInputHandler = (e) => {
                let el = e.target
                let newValue = unmask(el.value)
                let newCursorPosition;
                
                if (newValue.match(ccNumberPattern)) {
                    newValue = mask(newValue, 4, ccNumberSeparator);
                    
                    newCursorPosition = 
                        ccNumberInputOldCursor - checkSeparator(ccNumberInputOldCursor, 4) + 
                        checkSeparator(ccNumberInputOldCursor + (newValue.length - ccNumberInputOldValue.length), 4) + 
                        (unmask(newValue).length - unmask(ccNumberInputOldValue).length);
                    
                    el.value = (newValue !== "") ? newValue : "";
                } else {
                    el.value = ccNumberInputOldValue;
                    newCursorPosition = ccNumberInputOldCursor;
                }
                
                el.setSelectionRange(newCursorPosition, newCursorPosition);                
            }

            ccNumberInput.on("keydown", ccNumberInputKeyDownHandler);
            ccNumberInput.on("input", ccNumberInputInputHandler);

            // phone number input formatter
            let phoneNumberInput = $("#phoneInput")
            let phoneNumberPattern = /^\d{0,15}$/g
            let phoneNumberSeparator = " "
            let phoneNumberInputOldValue
            let phoneNumberInputOldCursor
            
            const phoneNumberInputKeyDownHandler = (e) => {
                let el = e.target;
                phoneNumberInputOldValue = el.value;
                phoneNumberInputOldCursor = el.selectionEnd;
            }
            
            const phoneNumberInputInputHandler = (e) => {
                let el = e.target
                let newValue = unmask(el.value)
                let newCursorPosition;
                
                if (newValue.match(phoneNumberPattern)) {
                    newValue = mask(newValue, 4, phoneNumberSeparator);
                    
                    newCursorPosition = 
                        phoneNumberInputOldCursor - checkSeparator(phoneNumberInputOldCursor, 4) + 
                        checkSeparator(phoneNumberInputOldCursor + (newValue.length - phoneNumberInputOldValue.length), 4) + 
                        (unmask(newValue).length - unmask(phoneNumberInputOldValue).length);
                    
                    el.value = (newValue !== "") ? newValue : "";
                } else {
                    el.value = phoneNumberInputOldValue;
                    newCursorPosition = phoneNumberInputOldCursor;
                }
                
                el.setSelectionRange(newCursorPosition, newCursorPosition);                
            }

            phoneNumberInput.on("keydown", phoneNumberInputKeyDownHandler);
            phoneNumberInput.on("input", phoneNumberInputInputHandler);
            
            // disable enable submit button by form condition
            const nextButton = (input, check) => {
                if (input || check) {
                    $('#submitForm').attr('disabled', 'disabled'); // updated according to http://stackoverflow.com/questions/7637790/how-to-remove-disabled-attribute-with-jquery-ie
                    $('#submitForm').removeClass('active-button')
                    $('#submitForm').addClass('nonactive-button')

                } else {
                    $('#submitForm').removeAttr('disabled'); // updated according to http://stackoverflow.com/questions/7637790/how-to-remove-disabled-attribute-with-jquery-ie
                    $('#submitForm').removeClass('nonactive-button')
                    $('#submitForm').addClass('active-button')
                    
                }
            }
            
            var inputEmpty = false;
            var checkEmpty = false;

            // disable enable submit button on page reload
            $('#form input[type=text]').each(function() {
                if ($(this).val() == '') {
                    inputEmpty = true;
                }
                
                nextButton(inputEmpty, checkEmpty);
            })

            $('#form input:checkbox').each(function() {
                if ($(this).is(":checked") == false) {
                    checkEmpty = true;
                }
            
                nextButton(inputEmpty, checkEmpty);
            });

            // disable enable submit button on input fill
            $('#form input[type=text]').keyup(function() {
                inputEmpty = false;

                $('#form input[type=text]').each(function() {
                    // console.log($(this))
                    if (($(this).val() == '')) {
                        inputEmpty = true;
                    }
                })
                
                console.log(inputEmpty)
                nextButton(inputEmpty, checkEmpty);
            })

            $('#form input:checkbox').on("change", function() {
                checkEmpty = false;

                $('#form input:checkbox').each(function() {
                    // console.log("---")
                    // console.log($(this).is(":checked"))

                    if (($(this).is(":checked") == false)) {
                        checkEmpty = true;
                    }
                });

                console.log(checkEmpty)
                nextButton(inputEmpty, checkEmpty);
            });

            // handle on submit
            $("#form").on("submit", function(e){
                e.preventDefault();

                let dc = $("#dcInput").val();
                let phone = $("#phoneInput").val();
                let check1 = $( "input[type=checkbox][name=check1]:checked" ).val();
                let check2 = $( "input[type=checkbox][name=check2]:checked" ).val();

                let data = {
                    "debit_card": unmask(dc),
                    "phone": phone,
                    "check1": check1,
                    "check2": check2
                }

                $("#buttonText").hide()
                $("#loadingIcon").show()
                $("#submitForm").attr('disabled', 'disabled');
                $("#submitForm").removeClass('active-button')                                
                $("#submitForm").addClass('loading-button')                                
                $.ajax({
                    type: 'post',
                    url: 'http://localhost:8080/home',
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        $("#loadingIcon").hide()
                        $("#buttonText").show()
                        
                        console.log(data)
                        if(data["response_code"] == 'SUCCESS'){
                            location.href = "http://127.0.0.1:5500/otp.html"
                        }else{
                            $(".response").css("margin-top", "10px")
                            $(".response").append(JSON.stringify(data))
                        }

                        $("#submitForm").removeAttr('disabled');
                        $("#submitForm").removeClass('loading-button')                                
                        $("#submitForm").addClass('active-button')
                    }
                });
            })
        })

    </script>
</body>
</html>